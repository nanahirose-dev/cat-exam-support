<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã­ã“å¿œæ´ãƒšãƒ¼ã‚¸ï½œä¸­å­¦å—é¨“</title>
  <meta name="theme-color" content="#fff0f7" />
  <style>
    :root{
      --bg1:#fff0f7;
      --bg2:#f2fbff;
      --card:#ffffffcc;
      --ink:#3a3a3a;
      --muted:#6b6b6b;
      --accent:#ff7fb3;
      --accent2:#7dd3ff;
      --ok:#d8f7d7;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% 0%, var(--bg2), transparent 60%),
        radial-gradient(1000px 700px at 90% 10%, #fff6cc, transparent 55%),
        linear-gradient(180deg, var(--bg1), #ffffff 60%);
      min-height:100svh;
    }
    .wrap{max-width:480px;margin:0 auto;padding:14px 14px 24px;}
    .hero{
      position:relative;
      border-radius:26px;
      overflow:hidden;
      box-shadow:var(--shadow);
      background:linear-gradient(135deg,#ffe2ef,#e8f8ff);
      aspect-ratio:16/10;
      min-height:260px;
    }
    canvas{display:block;width:100%;height:100%;}
    .hero-ui{
      position:absolute; inset:0;
      display:flex; flex-direction:column; justify-content:space-between;
      padding:14px;
      pointer-events:none;
      z-index:2;
    }
    .topline{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(255,255,255,.65);
      backdrop-filter:blur(8px);
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      font-weight:700;letter-spacing:.02em;
    }
    .badge small{font-weight:600;color:var(--muted)}
    .hint{
      font-size:.92rem;
      color:rgba(58,58,58,.85);
      background:rgba(255,255,255,.58);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter:blur(8px);
      width:fit-content;
      max-width:92%;
      box-shadow:0 10px 24px rgba(0,0,0,.06);
    }
    .hint strong{color:var(--accent)}
    .tap{display:inline-flex;align-items:center;gap:8px;margin-top:8px;font-size:.86rem;color:rgba(58,58,58,.75);}
    .tap .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 6px rgba(255,127,179,.22);
      animation:pulse 1.4s infinite;
    }
    @keyframes pulse{
      0%{transform:scale(.9);opacity:.7}
      60%{transform:scale(1.05);opacity:1}
      100%{transform:scale(.9);opacity:.7}
    }

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    .card{
      background:var(--card);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.7);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.06);
    }
    h1{margin:10px 2px 6px;font-size:1.35rem;letter-spacing:.02em;}
    .sub{margin:0 2px 10px;color:var(--muted);font-size:.95rem;line-height:1.5;}
    h2{margin:0 0 10px;font-size:1.05rem;display:flex;align-items:center;gap:8px;}
    .pill{font-size:.82rem;padding:4px 10px;border-radius:999px;background:rgba(255,127,179,.14);color:#b0185a;font-weight:700;}
    .checklist{list-style:none;padding:0;margin:0;display:grid;gap:10px;}
    .item{
      display:flex;align-items:center;gap:12px;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.04);
      transition:transform .12s ease, background .2s ease;
    }
    .item:active{transform:scale(.995)}
    .item.done{background:linear-gradient(90deg, rgba(216,247,215,.9), rgba(255,255,255,.65));text-decoration:line-through;color:#2f6b33;}
    input[type="checkbox"]{width:22px;height:22px;accent-color:var(--accent);flex:0 0 auto;}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:.92rem;}
    .count{font-size:1.25rem;font-weight:900;letter-spacing:.02em;}
    .count small{font-size:.92rem;font-weight:800;color:var(--muted);}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .btn{
      appearance:none;border:0;cursor:pointer;
      background:linear-gradient(135deg,var(--accent),#ffb3d2);
      color:white;font-weight:900;
      padding:10px 14px;border-radius:14px;
      box-shadow:0 10px 22px rgba(255,127,179,.25);
      transition:transform .12s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn2{background:linear-gradient(135deg,var(--accent2),#b7ecff);box-shadow:0 10px 22px rgba(125,211,255,.25);}
    textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      padding:10px 12px;
      font-size:1rem;
      resize:none;
      background:rgba(255,255,255,.78);
      outline:none;
    }
    textarea:focus{
      border-color:rgba(255,127,179,.5);
      box-shadow:0 0 0 4px rgba(255,127,179,.18);
    }
    .footer{text-align:center;color:rgba(58,58,58,.7);font-size:.9rem;margin-top:14px;}

    .spark{
      position:fixed;
      pointer-events:none;
      width:10px;height:10px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #fff, var(--accent));
      opacity:.9;
      animation:pop .75s ease-out forwards;
      z-index:9999;
    }
    @keyframes pop{
      from{transform:translate(-50%,-50%) scale(.6);opacity:.9}
      to{transform:translate(var(--dx), var(--dy)) scale(0);opacity:0}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero" id="hero" aria-label="çŒ«ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å¤‰åŒ–ï¼‰">
      <canvas id="c"></canvas>
      <div class="hero-ui">
        <div class="topline">
          <div class="badge">ğŸ¾ ã­ã“å¿œæ´ãƒ¢ãƒ¼ãƒ‰ <small id="moodLabel">--</small></div>
          <div class="badge">ğŸ—“ï¸ <span id="daysLabel">ã‚ã¨ -- æ—¥</span></div>
        </div>
        <div>
          <div class="hint" id="heroMessage">çŒ«ãŒãªã«ã‹ä¼ã‚“ã§ã„ã¾ã™â€¦ <strong>ã‚¯ãƒªãƒƒã‚¯</strong>ã™ã‚‹ã¨åŠ±ã¾ã—ã¾ã™ã€‚</div>
          <div class="tap"><span class="dot"></span>ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼šåŠ±ã¾ã—ï¼†çŒ«ã®å‹•ããƒã‚§ãƒ³ã‚¸</div>
        </div>
      </div>
    </div>

    <h1>ä¸­å­¦å—é¨“ã€ã­ã“ã¨ä¸€ç·’ã«ã€‚</h1>
    <p class="sub">æ¯æ—¥ã“ã“ã‚’é–‹ãã¨ã€çŒ«ãŒâ€œå¤‰ãªå‹•ãâ€ã§åŠ±ã¾ã—ã¾ã™ã€‚ã§ããŸã“ã¨ã¯å°ã•ãã¦OKã€‚ç©ã¿é‡ã­ãŒæœ€å¼·ã§ã™ã€‚</p>

    <div class="grid">
      <section class="card">
        <div class="row">
          <h2>ğŸ± ä»Šæ—¥ã®ä¸€è¨€ <span class="pill">ãƒ©ãƒ³ãƒ€ãƒ </span></h2>
          <button class="btn" id="nextMsg">ã‚‚ã†1å›</button>
        </div>
        <div id="messageBox" style="font-size:1.12rem; line-height:1.6; padding:10px 12px; background: rgba(255,255,255,.75); border-radius: 14px;">--</div>
        <div class="meta" style="margin-top:10px;">
          <span>ğŸ‘‰ æ°—æŒã¡ãŒé‡ã„æ—¥ã¯ã€ŒçŸ­ãã€ã§ã‚‚OK</span>
          <span>ğŸ‘‰ 1å•ã§ã‚‚â€œå‰é€²â€</span>
        </div>
      </section>

      <section class="card">
        <h2>âœ… ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯</h2>
        <ul class="checklist" id="checklist"></ul>
        <div class="meta" style="margin-top:10px;"><span>å®Œäº†ã™ã‚‹ã¨ã€ã«ã‚‡ãã£ã¨â€œé”æˆæ„Ÿâ€è‰²ã«ãªã‚Šã¾ã™ã€‚</span></div>
      </section>

      <section class="card">
        <div class="row">
          <h2>â³ å…¥è©¦ã¾ã§</h2>
          <button class="btn btn2" id="setDate">æ—¥ä»˜ã‚’å¤‰ãˆã‚‹</button>
        </div>
        <div class="count"><span id="countdown">--</span> <small id="countdownSub"></small></div>
        <div class="meta" style="margin-top:10px;"><span>â€»æ—¥ä»˜ã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã ã‘ï¼‰ã€‚</span></div>
      </section>

      <section class="card">
        <h2>ğŸ“ ä»Šæ—¥ã§ããŸã“ã¨ï¼ˆ1è¡Œãƒ¡ãƒ¢ï¼‰</h2>
        <textarea id="memo" rows="2" placeholder="ä¾‹ï¼šæ¼¢å­—10åˆ†ã‚„ã£ãŸï¼è¨ˆç®—3å•ã ã‘â€¦ã§ã‚‚OK"></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="saveMemo">ä¿å­˜</button>
          <button class="btn btn2" id="clearMemo">æ¶ˆã™</button>
        </div>
        <div class="meta" style="margin-top:10px;"><span>ä¿å­˜å…ˆï¼šlocalStorageï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰</span></div>
      </section>
    </div>

    <div class="footer">ğŸ¾ ã­ã“ã¯è¨€ã„ã¾ã™ã€‚ã€Œã§ããŸåˆ†ã ã‘ã€ã¡ã‚ƒã‚“ã¨å¼·ããªã‚‹ã€‚ã€</div>
  </div>

<script>
/* =========================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================= */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function burstSpark(x, y){
  for(let i=0;i<10;i++){
    const s = document.createElement("div");
    s.className = "spark";
    s.style.setProperty("--dx", (Math.random()*80 - 40) + "px");
    s.style.setProperty("--dy", (Math.random()*80 - 40) + "px");
    s.style.left = x + "px";
    s.style.top  = y + "px";
    document.body.appendChild(s);
    setTimeout(()=>s.remove(), 900);
  }
}
function burstSparkAtCenter(el){
  const r = el.getBoundingClientRect();
  burstSpark(r.left + r.width/2, r.top + r.height/2);
}

/* =========================
   ãƒ‡ãƒ¼ã‚¿
========================= */
const MSGS = [
  "ä»Šæ—¥ã¯â€œ1å•ã§ã‚‚â€ã§å‹ã¡ã€‚ã­ã“åˆ¤å®šï¼šåˆæ ¼â—",
  "ä¸å®‰ãŒã‚ã‚‹ã®ã¯ã€ã¡ã‚ƒã‚“ã¨å‘ãåˆã£ã¦ã‚‹è¨¼æ‹ ã€‚",
  "ã­ã“ã¯çŸ¥ã£ã¦ã‚‹ã€‚ã‚ãªãŸã®åŠªåŠ›ã¯ã€æ¸›ã‚‰ãªã„ã€‚",
  "ç–²ã‚ŒãŸã‚‰ã€ä¸¸ããªã£ã¦ä¼‘ã‚€ã€‚ä½œæˆ¦å‹ã¡ã€‚",
  "æ˜¨æ—¥ã®è‡ªåˆ†ã‚ˆã‚Šã€1ãƒŸãƒªé€²ã‚“ã ã‚‰å¤§å„ªå‹ã€‚",
  "ã§ããªã„æ—¥ãŒã‚ã£ã¦ã‚‚OKã€‚ç¶šã‘ã‚‹ã®ãŒå¼·ã•ã€‚",
  "é›†ä¸­ã§ããªã„æ—¥ã¯â€œæ•´ãˆã‚‹æ—¥â€ã€‚ãã‚Œã‚‚å‹‰å¼·ã€‚",
  "ä»Šæ—¥ã¯çŸ­ãã€æ˜æ—¥ã¾ãŸã€‚ã­ã“å¼ãƒ»é•·æœŸæˆ¦ã€‚",
  "æœ¬ç•ªã¯â€œç©ã¿é‡ã­ã®å›åæ—¥â€ã€‚ä»Šã¯è²¯é‡‘ä¸­ã€‚",
  "ã­ã“ã‹ã‚‰ã®æ¥µæ„ï¼šæ·±å‘¼å¸ã—ã¦ã€ç›®ã®å‰1ã¤ã€‚"
];

const CHECKS_DEFAULT = [
  "æ¼¢å­—ï¼ˆ10åˆ†ã§ã‚‚OKï¼‰",
  "è¨ˆç®—ï¼ˆ3å•ã§ã‚‚OKï¼‰",
  "ç†ç§‘ãƒ»ç¤¾ä¼šï¼ˆç”¨èª1å€‹ã§ã‚‚OKï¼‰",
  "ä»Šæ—¥ã®å¾©ç¿’ï¼ˆ1ã¤ã ã‘ï¼‰",
  "æ—©ã‚ã«å¯ã‚‹ï¼ˆæœ€å¼·ï¼‰"
];

const K = {
  memo: "cat_exam_memo_v3",
  exam: "cat_exam_date_v3",
  checks: "cat_exam_checks_v3"
};

/* =========================
   ä»Šæ—¥ã®ä¸€è¨€
========================= */
const messageBox = document.getElementById("messageBox");
const heroMessage = document.getElementById("heroMessage");
function pickMsg(){
  const m = MSGS[Math.floor(Math.random()*MSGS.length)];
  messageBox.textContent = m;
  return m;
}
pickMsg();
document.getElementById("nextMsg").addEventListener("click", () => {
  pickMsg();
  burstSparkAtCenter(messageBox);
});

/* =========================
   ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
========================= */
const checklistEl = document.getElementById("checklist");
function loadChecks(){
  try{
    const raw = localStorage.getItem(K.checks);
    if(!raw) return CHECKS_DEFAULT.map(t=>({t,done:false}));
    const arr = JSON.parse(raw);
    return arr.map(x=>({t:x.t, done:!!x.done}));
  }catch{
    return CHECKS_DEFAULT.map(t=>({t,done:false}));
  }
}
function saveChecks(state){
  localStorage.setItem(K.checks, JSON.stringify(state));
}
let checks = loadChecks();
function renderChecks(){
  checklistEl.innerHTML = "";
  checks.forEach((c, idx)=>{
    const li = document.createElement("li");
    li.className = "item" + (c.done ? " done" : "");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = c.done;
    cb.addEventListener("change", ()=>{
      checks[idx].done = cb.checked;
      saveChecks(checks);
      renderChecks();
      cat.boost(cb.checked ? 1 : 0.2);
      burstSparkAtCenter(li);
    });
    const span = document.createElement("span");
    span.textContent = c.t;
    li.appendChild(cb);
    li.appendChild(span);
    checklistEl.appendChild(li);
  });
}
renderChecks();

/* =========================
   ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
========================= */
const countdownEl = document.getElementById("countdown");
const countdownSub = document.getElementById("countdownSub");
const daysLabel = document.getElementById("daysLabel");

function getExamDate(){
  const raw = localStorage.getItem(K.exam);
  if(raw){
    const d = new Date(raw);
    if(!isNaN(d)) return d;
  }
  return new Date("2026-02-01T00:00:00"); // åˆæœŸå€¤ï¼ˆå¿…è¦ãªã‚‰å¤‰æ›´ï¼‰
}
function setExamDate(d){
  localStorage.setItem(K.exam, d.toISOString());
  updateCountdown();
}
function updateCountdown(){
  const examDate = getExamDate();
  const now = new Date();
  const diffDays = Math.ceil((examDate - now) / (1000*60*60*24));
  if(diffDays > 0){
    countdownEl.textContent = `ã‚ã¨ ${diffDays} æ—¥`;
    countdownSub.textContent = "ä»Šæ—¥ã®1æ­©ãŒã€å½“æ—¥ã®è‡ªä¿¡ã«ãªã‚Šã¾ã™ã€‚";
    daysLabel.textContent = `ã‚ã¨ ${diffDays} æ—¥`;
  }else if(diffDays === 0){
    countdownEl.textContent = "ã„ã‚ˆã„ã‚ˆä»Šæ—¥ï¼";
    countdownSub.textContent = "æ·±å‘¼å¸ã—ã¦ã€ç›®ã®å‰ã®1å•ã‹ã‚‰ã€‚";
    daysLabel.textContent = "æœ¬æ—¥ï¼";
  }else{
    countdownEl.textContent = "æœ¬ç•ªã€ãŠã¤ã‹ã‚Œã•ã¾ï¼";
    countdownSub.textContent = "ã“ã“ã¾ã§æ¥ãŸè‡ªåˆ†ã‚’ã€ã­ã“ãŒèª‡ã£ã¦ã„ã¾ã™ã€‚";
    daysLabel.textContent = "å®Œäº†";
  }
}
updateCountdown();

document.getElementById("setDate").addEventListener("click", ()=>{
  const cur = getExamDate();
  const y = cur.getFullYear();
  const m = String(cur.getMonth()+1).padStart(2,"0");
  const d = String(cur.getDate()).padStart(2,"0");
  const input = prompt("å…¥è©¦æ—¥ã‚’ YYYY-MM-DD ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š2026-01-10ï¼‰", `${y}-${m}-${d}`);
  if(!input) return;
  const nd = new Date(input + "T00:00:00");
  if(isNaN(nd)){
    alert("æ—¥ä»˜ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ä¾‹ï¼š2026-01-10");
    return;
  }
  setExamDate(nd);
  burstSparkAtCenter(document.getElementById("setDate"));
});

/* =========================
   ãƒ¡ãƒ¢
========================= */
const memo = document.getElementById("memo");
memo.value = localStorage.getItem(K.memo) || "";
document.getElementById("saveMemo").addEventListener("click", ()=>{
  localStorage.setItem(K.memo, memo.value.trim());
  burstSparkAtCenter(document.getElementById("saveMemo"));
  cat.cheer();
});
document.getElementById("clearMemo").addEventListener("click", ()=>{
  if(!confirm("ãƒ¡ãƒ¢ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ä¿å­˜ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) return;
  memo.value = "";
  localStorage.removeItem(K.memo);
  burstSparkAtCenter(document.getElementById("clearMemo"));
});

/* =========================
   ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼šCanvasçŒ«ï¼ˆç¢ºå®Ÿã«è¡¨ç¤ºï¼†ã‚¯ãƒªãƒƒã‚¯åå¿œï¼‰
========================= */
const hero = document.getElementById("hero");
const canvas = document.getElementById("c");
const moodLabel = document.getElementById("moodLabel");
const ctx = canvas.getContext("2d", { alpha:true });

function resizeCanvasSafely(){
  const r = hero.getBoundingClientRect();
  if(!r.width || !r.height) return false;
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  canvas.width  = Math.floor(r.width  * dpr);
  canvas.height = Math.floor(r.height * dpr);
  canvas.style.width  = r.width + "px";
  canvas.style.height = r.height + "px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return true;
}
window.addEventListener("resize", ()=>{ resizeCanvasSafely(); }, {passive:true});

/* ---- çŒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå…ˆã«ç”Ÿæˆã—ã¦ãŠãï¼šsetMoodãŒå®‰å…¨ã«å‘¼ã¹ã‚‹ï¼‰ ---- */
const cat = (() => {
  let t = 0;
  let mode = "wiggle";
  let energy = 0;
  let speech = {text:"", until:0};
  let running = false;

  function setMode(m){ mode = m; }
  function boost(v){ energy = Math.min(2.2, energy + v*0.25); }
  function cheer(){
    const lines = ["ãˆã‚‰ã„ï¼ãˆã‚‰ã™ãï¼","ãã®1è¡Œã€æœªæ¥ã®æ­¦å™¨ã€‚","ã†ã‚€â€¦æˆé•·ã®æ°—é…ï¼","ä»Šæ—¥ã®ã‚ãªãŸã€å¼·ã„ã€‚","ã«ã‚ƒã‚‹ã»ã©ã€ã„ã„èª¿å­ï¼"];
    speech.text = lines[Math.floor(Math.random()*lines.length)];
    speech.until = performance.now() + 1400;
    boost(1.0);
  }

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function drawBG(w,h){
    for(let i=0;i<10;i++){
      const x = (w*0.1) + (i* w*0.09) + Math.sin(t*0.4+i)*18;
      const y = (h*0.25) + Math.cos(t*0.3+i)*16;
      const rr = 30 + Math.sin(t*0.5+i)*6;
      ctx.beginPath();
      ctx.fillStyle = `rgba(255,255,255,${0.10 + i*0.005})`;
      ctx.arc(x,y,rr,0,Math.PI*2);
      ctx.fill();
    }
    for(let i=0;i<18;i++){
      const x = (i*37 + (t*40)) % (w+40) - 20;
      const y = (h*0.15) + (i*29 % (h*0.6)) + Math.sin(t+i)*10;
      const a = 0.06 + 0.05*Math.sin(t*1.3+i);
      ctx.fillStyle = `rgba(255,255,255,${a})`;
      ctx.fillRect(x,y,2,2);
    }
  }

  function drawCat(w,h){
    const cx = w*0.52, cy = h*0.62;

    let dx=0, dy=0, rot=0, squash=1, stretch=1;
    const e = energy;

    if(mode==="wiggle"){
      dx = Math.sin(t*9) * (6 + e*6);
      rot = Math.sin(t*6)*0.06;
      squash = 1 - 0.06*Math.sin(t*7);
      stretch = 1 + 0.04*Math.sin(t*7);
    }else if(mode==="hop"){
      const jump = Math.max(0, Math.sin(t*4));
      dy = -jump * (28 + e*10);
      dx = Math.sin(t*2)*8;
      squash = 1 - 0.18*jump;
      stretch = 1 + 0.20*jump;
      rot = Math.sin(t*2)*0.05;
    }else if(mode==="roll"){
      rot = t*0.9;
      dx = Math.sin(t*1.5)*22;
      dy = Math.cos(t*1.2)*10;
      squash = 1 - 0.08*Math.sin(t*3);
      stretch = 1 + 0.08*Math.sin(t*3);
    }else if(mode==="stretch"){
      const s = (Math.sin(t*2)+1)/2;
      stretch = 1 + 0.55*s;
      squash = 1 - 0.25*s;
      dy = -s*10;
      rot = Math.sin(t*2)*0.03;
      dx = Math.sin(t*1.5)*6;
    }

    // å½±
    ctx.save();
    ctx.translate(cx+dx, cy+44);
    ctx.scale(1.1, 0.7);
    ctx.fillStyle = "rgba(0,0,0,.10)";
    ctx.beginPath();
    ctx.ellipse(0,0,80,26,0,0,Math.PI*2);
    ctx.fill();
    ctx.restore();

    ctx.save();
    ctx.translate(cx+dx, cy+dy);
    ctx.rotate(rot);
    ctx.scale(squash, stretch);

    const fur = "#ffe7c9";
    const fur2 = "#ffd7a8";
    const line = "rgba(58,58,58,.85)";

    // ã‹ã‚‰ã 
    ctx.fillStyle = fur2;
    roundRect(-85, -10, 170, 110, 40); ctx.fill();
    ctx.fillStyle = fur;
    roundRect(-80, -18, 160, 105, 38); ctx.fill();

    // ã‚ãŸã¾
    ctx.fillStyle = fur;
    roundRect(-65, -110, 130, 108, 46); ctx.fill();

    // è€³
    ctx.strokeStyle = line; ctx.lineWidth = 3; ctx.lineJoin="round";
    ctx.fillStyle = fur2;
    ctx.beginPath(); ctx.moveTo(-48,-108); ctx.lineTo(-78,-140); ctx.lineTo(-60,-92); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo( 48,-108); ctx.lineTo( 78,-140); ctx.lineTo( 60,-92); ctx.closePath(); ctx.fill(); ctx.stroke();

    // ç›®
    ctx.fillStyle = "rgba(58,58,58,.88)";
    ctx.beginPath(); ctx.ellipse(-24,-78,10,13,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse( 24,-78,10,13,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.beginPath(); ctx.ellipse(-27,-82,2.2,3.2,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse( 21,-82,2.2,3.2,0,0,Math.PI*2); ctx.fill();

    // å£
    ctx.strokeStyle = line; ctx.lineWidth = 3; ctx.lineCap="round";
    ctx.beginPath(); ctx.moveTo(0,-70); ctx.lineTo(0,-66); ctx.stroke();
    ctx.beginPath(); ctx.arc(-8,-64,10,0.1,1.2); ctx.stroke();
    ctx.beginPath(); ctx.arc( 8,-64,10,1.95,3.04); ctx.stroke();

    // ã»ã£ãº
    ctx.fillStyle = "rgba(255,127,179,.22)";
    ctx.beginPath(); ctx.ellipse(-22,-62,12,9,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse( 22,-62,12,9,0,0,Math.PI*2); ctx.fill();

    // ã—ã£ã½
    ctx.save();
    ctx.translate(76, 18);
    ctx.rotate(0.4 + Math.sin(t*3)*0.25);
    ctx.fillStyle = fur2;
    roundRect(-9, -38, 18, 76, 10); ctx.fill();
    ctx.restore();

    // ã‚„ã‚‹æ°—ã‚­ãƒ©
    const star = 0.45 + Math.max(0,Math.sin(t*2))*0.35 + e*0.08;
    ctx.save();
    ctx.translate(0,-132);
    ctx.rotate(Math.sin(t*2)*0.15);
    ctx.scale(star, star);
    const g = ctx.createRadialGradient(0,0,1,0,0,18);
    g.addColorStop(0, "rgba(255,255,255,.95)");
    g.addColorStop(1, "rgba(255,127,179,0)");
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.moveTo(0,-18); ctx.lineTo(5,-5); ctx.lineTo(18,0); ctx.lineTo(5,5);
    ctx.lineTo(0,18); ctx.lineTo(-5,5); ctx.lineTo(-18,0); ctx.lineTo(-5,-5);
    ctx.closePath(); ctx.fill();
    ctx.restore();

    ctx.restore();

    // ãµãã ã—
    const now = performance.now();
    if(now < speech.until){
      ctx.save();
      ctx.font = "700 14px -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif";
      const text = speech.text;
      const bw = Math.min(240, ctx.measureText(text).width + 24);
      const bh = 40;
      ctx.translate(cx+dx, cy+dy-150);
      ctx.fillStyle = "rgba(255,255,255,.75)";
      ctx.strokeStyle = "rgba(58,58,58,.20)";
      ctx.lineWidth = 1.5;
      roundRect(-bw/2, -bh/2, bw, bh, 14); ctx.fill(); ctx.stroke();
      ctx.fillStyle = "rgba(58,58,58,.85)";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(text, 0, 0, bw-12);
      ctx.restore();
    }
  }

  function frame(){
    if(!running) return;
    const r = hero.getBoundingClientRect();
    const w = r.width, h = r.height;
    if(!w || !h){ requestAnimationFrame(frame); return; }

    energy *= 0.985;
    ctx.clearRect(0,0,w,h);
    drawBG(w,h);
    drawCat(w,h);

    t += 0.016 + energy*0.01;
    requestAnimationFrame(frame);
  }

  function start(){
    if(running) return;
    running = true;
    frame();
  }

  return { setMode, boost, cheer, start };
})();

/* ---- ãƒ¢ãƒ¼ãƒ‰ï¼ˆcat ãŒä½œã‚‰ã‚ŒãŸå¾Œã« setMood ã‚’å‘¼ã¶ã®ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã›ã‚“ï¼‰ ---- */
const moods = [
  {name:"ã·ã‚‹ã·ã‚‹", id:"wiggle"},
  {name:"ã´ã‚‡ã‚“", id:"hop"},
  {name:"ã”ã‚ã‚“", id:"roll"},
  {name:"ã®ã³ã€œ", id:"stretch"},
];
let moodIndex = 0;
function setMood(i){
  moodIndex = (i + moods.length) % moods.length;
  moodLabel.textContent = moods[moodIndex].name;
  cat.setMode(moods[moodIndex].id);
}
setMood(0);

/* ã‚¯ãƒªãƒƒã‚¯ã§åŠ±ã¾ã—ï¼†ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ */
hero.addEventListener("pointerdown", (e)=>{
  const msg = pickMsg();
  heroMessage.innerHTML = `ğŸ¾ ã€Œ${escapeHtml(msg)}ã€<br><span style="color:rgba(58,58,58,.75); font-size:.92rem;">çŒ«ã®å‹•ããŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚</span>`;
  setMood(moodIndex+1);
  cat.boost(1.2);
  burstSpark(e.clientX, e.clientY);
}, {passive:true});

/* loadå¾Œã«ã€ã‚µã‚¤ã‚ºãŒå–ã‚Œã‚‹ã¾ã§å¾…ã£ã¦ã‹ã‚‰é–‹å§‹ */
window.addEventListener("load", () => {
  const tryStart = () => {
    const ok = resizeCanvasSafely();
    if(!ok){ requestAnimationFrame(tryStart); return; }
    cat.start();
  };
  tryStart();
});

/* ãƒ¡ãƒ¢å…¥åŠ›ã§é™ã‹ã«åŠ é€Ÿ */
let memoTimer = null;
memo.addEventListener("input", ()=>{
  if(memoTimer) clearTimeout(memoTimer);
  memoTimer = setTimeout(()=>{
    if(memo.value.trim().length>0) cat.boost(0.5);
  }, 350);
}, {passive:true});
</script>
</body>
</html>
